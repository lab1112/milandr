---
title: Алгоритмы ЦОС
subtitle: Работа с платой миландр
date: 31 марта 2021 г.
---

![local](./pic/dsp.png)

# Этап 1. Алгоритмы обработки сигнала в процессоре

## Задачи
- [ ] Сравнение работы DMA c матматической моделью в MatLab;
- [x] Аналого цифровое преобразование;
- [x] IQ демодуляцию;
- [x] Канальную фильтрацию;
- [ ] Коррекцию квадратурного дисбаланса;
- [ ] Тонкую коррекцию смещения по частоте;
- [ ] Корреляцию;
- [ ] Вычисление амплитуды;
- [ ] Оптимальное обнаружение;
- [ ] Передача результатов обработки в контроллер МКПД ПО ГОСТ Р 52070-2003;
- [ ] Синхронизацию с моментом начала передачи;
- [ ] Вычисление параметров опорного колебания в ФАПЧ.

## Аналого цифровое преобразование
Входной сигнал суммарного канала обозначим S~if~. 
Выборки сигнала обозначим S~i~. 
АЦП соединен с процессором через LINK порт. 
Частота дискретизации АЦП f~s~ равна 125 МГц.

## IQ демодуляция
Выборки входного сигнала Si поступают на сопроцессор UP/DOWN, в котором происходит перенос спектра сигнала на нулевую частоту, квадратурная демодуляция, децимация и предварительная канальная фильтрация.
Входные данные поступают на сопроцессор через LINK порт от АЦП. Выходные данные сопроцессора передаются с помощью DMA в буфер памяти на кристале. Выходные данные представляют собой упакованные выборки YiIQ квадратурных сигналов в формате 32 бит (по 16 бит на реальную и мнимую квадратуру).

## Корреляция
Процедура корреляции наиболее ресурсоемкая операция. Корреляция выполняется отдельно для реальной и мнимой составляющей демодулированного сигнала YiIQ с сигналом модуляции hk. Сигнал на выходе коррелятора обозначим ZiI и ZiQ.
Таблица выборок сигнала hk хранится во внешней энергонезависимой части и оперативно подгружается частями перед выполнением корреляции. Поэтому необходимо:
• при линковании разместить секцию инициализированных данных выборок сигнала hk во флэш;
• настроить канал DMA для подгрузки данных перед выполнением корреляции.

```matlab
// correlation 
short yi[N] ; // I demodulated input short 
yq[N] ; // Q demodulated input short 
h[L] ; // matched IR short 
zi[N] ; // I matched output 
short zq[N] ; // Q matched output 
for(i=0;i<N;i++) 
{ 
   zi[i] = h[0]*yi[i] ; 
   zq[i] = h[0]*yq[i] ; 
   for(k=1;k<L;k++) 
      { 
         zi[i] += h[k]*yi[i+k] ; 
         zq[i] += h[k]*yq[i+k] ;
      }
}
```
Для вычисления корреляции возможно использовать сопроцессоры:
• умножитель;
• коммуникационно-логическое устройство (CLU).

## Корреляция в умножители
При использовании умножителя необходимо учитывать следующее:
1. умножитель способен выполнять операции умножения с накоплением (product) над упакованными 16 разрядными числами (см. главу 5.);
2. за один такт умножитель способен перемножить 4 пары 16 битных слов;
3. выходные данные цифрового конвертера представляют собой чередующиеся значения IQ квадратур;
4. параллельно можно выполнять 2 операции умножения с накоплением в блоках X и Y.
Поэтому псевдокод, поясняющий операцию корреляции может быть модифицирован следующим образом.
```c
// correlation 
int yiq[N] ; // IQ pairs demodulated input 
short h[L] ; // matched IR 
short zi[N] ; // I matched output 
short zq[N] ; // Q matched output 
register int R0,R1,R2,R3 ; 
register int MR0,MR1,MR2,MR3 ; 
for(i=0;i<N;i+=2) 
{
   MR0=MR1=MR2=MR3=0 ; 
   for(k=0;k<L;k+=2) 
   { 
      R0 = yiq[i+k] ; 
      R1 = yiq[i+k+1] ; 
      R2 = h[k] + h[k]<<16 ; 
      R3 = h[k+1] + h[k+1]<<16 ; 
      MR0 += low(R0*R2) ; 
      MR1 += high(R0*R2) ; 
      MR2 += low(R1*R3) ; 
      MR3 += high(R1*R3) ; 
    } 
    zi[i] = MR0+MR2 ; 
    zq[i] = MR1+MR3 ; 
}
```
low()
Псевдофункция, обозначает операцию над младшими 16 битами 32 разрядных чисел
high()
Псевдофункция, обозначает операцию над старшими 16 битами 32 разрядных чисел

Ключевые операции на ассемблере приведены ниже.
```
;умножение с накоплением, предварительное обнуление аккумуляторов
XMR3:0 += R1:0 * R3:2(C) 
;умножение с накоплением 
XMR3:0 += R1:0 * R3:2
```

## Корреляция в CLU
На основе результатов дальнейшей проработки.

## Отчетность
1. ---
3. ---
4. ---
5. ---

## Состав стенда
1. [+]Генератор 33x
2. [+]Отладочная плата 1498
3. [+]ПК с matlab и средствами разработки, LAN
4. [+]Отладочный комплект для процессора цифровой обработки сигналов 1967ВН044.
5. [+]FAR

## Вопросы и замечания
1. Режим передачи 21/10.
2. Максимальный размер буфера для накопления? внутри и в в SDRAM ----- <- Максимальный размер (int32)[65536] на 1 банк памяти, банков 6, +  SDRAM

## Для справки Downconverter
1. ФНЧ на основе скользящего среднего. Хорошее описание про фильтр 
[тут](http://www.dsplib.ru/content/cic/cic.html) и [тут](http://www.dsplib.ru/content/cicid/cicid.html)
